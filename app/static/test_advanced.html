<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FastAPI Chat Service Test (Full)</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>FastAPI Chat Service Test (Full)</h1>

    <section>
        <h2>1. 회원가입</h2>
        <input type="text" id="signup-username" placeholder="Username">
        <input type="email" id="signup-email" placeholder="Email">
        <input type="password" id="signup-password" placeholder="Password">
        <button onclick="signup()">회원가입</button>
    </section>

    <section>
        <h2>2. 로그인</h2>
        <input type="email" id="login-email" placeholder="Email">
        <input type="password" id="login-password" placeholder="Password">
        <button onclick="login()">로그인</button>
        <p id="token-info"></p>
    </section>

    <section>
        <h2>3. 대화 시작</h2>
        <textarea id="start-content" placeholder="첫 메시지"></textarea>
        <button onclick="startConversation()">대화 시작</button>
        <p id="conversation-info"></p>
    </section>

    <section>
        <h2>4. 메시지 추가</h2>
        <textarea id="message-content" placeholder="추가할 메시지"></textarea>
        <button onclick="addMessage()">메시지 추가</button>
    </section>

    <section>
        <h2>5. 대화 삭제</h2>
        <button onclick="deleteConversation()">대화 삭제</button>
    </section>

    <section>
        <h2>6. 대화 목록 조회</h2>
        <button onclick="fetchConversations()">대화 목록 가져오기</button>
        <ul id="conversation-list"></ul>
    </section>

    <section>
        <h2>7. 메시지 목록 조회</h2>
        <ul id="message-list"></ul>
    </section>

    <script>
        let accessToken = "";
        let currentConvId = "";

        async function signup() {
            try {
                const username = document.getElementById("signup-username").value;
                const email = document.getElementById("signup-email").value;
                const password = document.getElementById("signup-password").value;

                const res = await axios.post("/auth/signup", {
                    username, email, password
                });

                alert("회원가입 성공: " + JSON.stringify(res.data));
            } catch (err) {
                alert("회원가입 실패: " + (err.response?.data?.detail || err.message));
            }
        }

        async function login() {
            try {
                const email = document.getElementById("login-email").value;
                const password = document.getElementById("login-password").value;

                const formData = new URLSearchParams();
                formData.append("username", email);
                formData.append("password", password);

                const res = await axios.post("/auth/token", formData, {
                    headers: { "Content-Type": "application/x-www-form-urlencoded" }
                });

                accessToken = res.data.access_token;
                document.getElementById("token-info").innerText = "Access Token: " + accessToken;
                alert("로그인 성공!");
            } catch (err) {
                alert("로그인 실패: " + (err.response?.data?.detail || err.message));
            }
        }

        async function startConversation() {
            try {
                const content = document.getElementById("start-content").value;

                const res = await axios.post("/chat/conversations", {
                    content
                }, {
                    headers: {
                        "Authorization": `Bearer ${accessToken}`
                    }
                });

                currentConvId = res.data.id;
                document.getElementById("conversation-info").innerText = "현재 대화방 ID: " + currentConvId;
                alert("대화 시작 성공!");
            } catch (err) {
                alert("대화 시작 실패: " + (err.response?.data?.detail || err.message));
            }
        }

        async function addMessage() {
            try {
                const content = document.getElementById("message-content").value;

                const res = await axios.post(`/chat/conversations/${currentConvId}/messages`, {
                    content
                }, {
                    headers: {
                        "Authorization": `Bearer ${accessToken}`
                    }
                });

                alert("메시지 추가 성공: " + JSON.stringify(res.data));
            } catch (err) {
                alert("메시지 추가 실패: " + (err.response?.data?.detail || err.message));
            }
        }

        async function deleteConversation() {
            try {
                await axios.delete(`/chat/conversations/${currentConvId}`, {
                    headers: {
                        "Authorization": `Bearer ${accessToken}`
                    }
                });

                alert("대화 삭제 성공!");
                document.getElementById("conversation-info").innerText = "";
            } catch (err) {
                alert("대화 삭제 실패: " + (err.response?.data?.detail || err.message));
            }
        }

        async function fetchConversations() {
            try {
                const res = await axios.get("/chat/conversations", {
                    headers: {
                        "Authorization": `Bearer ${accessToken}`
                    }
                });

                const conversations = res.data;
                const conversationList = document.getElementById("conversation-list");
                conversationList.innerHTML = "";

                conversations.forEach(conv => {
                    const li = document.createElement("li");
                    li.textContent = conv.title + " (" + conv.id + ")";
                    li.onclick = () => loadMessages(conv.id);
                    conversationList.appendChild(li);
                });

            } catch (err) {
                alert("대화 목록 가져오기 실패: " + (err.response?.data?.detail || err.message));
            }
        }

        async function loadMessages(convId) {
            try {
                currentConvId = convId;

                const res = await axios.get(`/chat/conversations/${convId}/messages`, {
                    headers: {
                        "Authorization": `Bearer ${accessToken}`
                    }
                });

                const messages = res.data;
                const messageList = document.getElementById("message-list");
                messageList.innerHTML = "";

                messages.forEach(msg => {
                    const li = document.createElement("li");
                    li.textContent = `[${msg.sender}] ${msg.content}`;
                    messageList.appendChild(li);
                });

            } catch (err) {
                alert("메시지 가져오기 실패: " + (err.response?.data?.detail || err.message));
            }
        }
    </script>
</body>
</html>
